<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN" "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">

<hibernate-mapping package="org.mycore.datamodel.classifications2.impl">
  <class name="MCRCategoryLink">
    <cache usage="nonstrict-read-write" />

    <id name="id" access="field">
      <generator class="identity" />
    </id>

    <natural-id mutable="true">
      <many-to-one name="category" class="MCRCategoryImpl" cascade="none" />
      <component name="objectReference" class="org.mycore.datamodel.classifications2.MCRCategLinkReference" access="field">
        <property name="objectID" />
        <property name="type" column="objectType" length="70" />
      </component>
    </natural-id>
    <query name="NumberPerClassID">
      <![CDATA[
SELECT cat.categID, count(distinct link.objectReference.objectID) as num
  FROM MCRCategoryLink link, MCRCategoryImpl cat, MCRCategoryImpl cattree
  WHERE cattree.internalID = link.category
    AND cattree.rootID=:classID
    AND cat.rootID=:classID
    AND cattree.left BETWEEN cat.left AND cat.right
  GROUP BY cat.categID
      ]]>
    </query>
    <!-- Tuned Query for MySQL -->
    <sql-query name="NumberPerClassID.MySQLDialect">
      <return-scalar column="categID" type="string" />
      <return-scalar column="num" type="integer" />
      <![CDATA[
SELECT baseCat.categID, count(distinct link.objectID) as num
  FROM MCRCategory baseCat
  LEFT JOIN MCRCategory AS node ON node.leftValue BETWEEN baseCat.leftValue AND baseCat.rightValue
  LEFT JOIN MCRCategoryLink AS link ON node.internalID = link.category
  WHERE node.ClassID=:classID
    AND baseCat.ClassID=:classID
  GROUP BY baseCat.categID
      ]]>
    </sql-query>
    <query name="NumberByTypePerClassID">
      <![CDATA[
SELECT cat.categID, count(distinct link.objectReference.objectID) as num
  FROM MCRCategoryLink link, MCRCategoryImpl cat, MCRCategoryImpl cattree
  WHERE cattree.internalID = link.category
    AND link.objectReference.type=:type
    AND cattree.rootID=:classID
    AND cat.rootID=:classID
    AND cattree.left BETWEEN cat.left AND cat.right
  GROUP BY cat.categID
      ]]>
    </query>
    <!-- Tuned Query for MySQL -->
    <sql-query name="NumberByTypePerClassID.MySQLDialect">
      <return-scalar column="categID" type="string" />
      <return-scalar column="num" type="integer" />
      <![CDATA[
SELECT p.parentCategID as categID, count(distinct link.objectID) as num
  FROM parents p, MCRCategoryLink link
  WHERE p.childID = link.category
    AND link.objectType=:type
    AND p.ClassID=:classID
  GROUP BY p.parentCategID
      ]]>
    </sql-query>
    <query name="NumberPerChildOfParentID">
      <![CDATA[
SELECT cat.categID, count(distinct link.objectReference.objectID) as num
  FROM MCRCategoryLink link, MCRCategoryImpl cat, MCRCategoryImpl cattree
  WHERE cattree.internalID = link.category
    AND cattree.rootID=:classID
    AND cat.parent.internalID=:parentID
    AND cattree.left BETWEEN cat.left AND cat.right
  GROUP BY cat.categID
      ]]>
    </query>
    <!-- Tuned Query for MySQL -->
    <sql-query name="NumberPerChildOfParentID.MySQLDialect">
      <return-scalar column="categID" type="string" />
      <return-scalar column="num" type="integer" />
      <![CDATA[
SELECT baseCat.categID, count( DISTINCT link.objectID ) AS num
  FROM MCRCategory AS baseCat
  LEFT JOIN MCRCategory AS node ON node.leftValue BETWEEN baseCat.leftValue AND baseCat.rightValue
  LEFT JOIN MCRCategoryLink AS link ON node.internalID = link.category
  WHERE node.ClassID=:classID
    AND baseCat.parentID=:parentID
  GROUP BY baseCat.categID
      ]]>
    </sql-query>
    <query name="NumberByTypePerChildOfParentID">
      <![CDATA[
SELECT cat.categID, count(distinct link.objectReference.objectID) as num
  FROM MCRCategoryLink link, MCRCategoryImpl cat, MCRCategoryImpl cattree
  WHERE cattree.internalID = link.category
    AND link.objectReference.type=:type
    AND cattree.rootID=:classID
    AND cat.parent.internalID=:parentID
    AND cattree.left BETWEEN cat.left AND cat.right
  GROUP BY cat.categID
      ]]>
    </query>
    <query name="deleteByObjectID">
      <![CDATA[
DELETE FROM MCRCategoryLink WHERE objectReference.objectID=:id and objectReference.type=:type
      ]]>
    </query>
    <query name="deleteByObjectCollection">
      <![CDATA[
DELETE FROM MCRCategoryLink WHERE objectReference.objectID IN (:ids) and objectReference.type=:type
      ]]>
    </query>
    <query name="ObjectIDByCategory">
      <![CDATA[
SELECT objectReference.objectID FROM MCRCategoryLink WHERE category.rootID=:rootID and category.categID=:categID
      ]]>
    </query>
    <query name="CategoryAndObjectID">
      <![CDATA[
SELECT link.objectReference.objectID
  FROM MCRCategoryLink link, MCRCategoryImpl cat, MCRCategoryImpl cattree
  WHERE cattree.internalID = link.category
    AND link.objectReference.objectID=:objectID
    AND link.objectReference.type=:type
    AND cattree.rootID=:rootID
    AND cat.rootID=:rootID
    AND cat.categID=:categID
    AND cattree.left BETWEEN cat.left AND cat.right
      ]]>
    </query>
    <query name="ObjectIDByCategoryAndType">
      <![CDATA[
SELECT objectReference.objectID FROM MCRCategoryLink WHERE category.rootID=:rootID and category.categID=:categID and objectReference.type=:type
      ]]>
    </query>
    <query name="categoriesByObjectID">
      <![CDATA[
SELECT category.rootID, category.categID FROM MCRCategoryLink WHERE objectReference.objectID=:id and objectReference.type=:type
      ]]>
    </query>
  </class>
</hibernate-mapping>
